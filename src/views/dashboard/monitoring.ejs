<div class="dashboard-grid" style="grid-template-columns: 1fr; gap: 24px;">
  <!-- Chart Card -->
  <div class="card chart-card">
    <div class="card-header">
      <h3 class="card-title">Grafik Tren Kualitas Udara (24 Jam Terakhir)</h3>
    </div>
    <div class="chart-container" style="height: 300px; position: relative;">
      <canvas id="monitoringChart" data-measurements="<%= JSON.stringify(measurements || []) %>"></canvas>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Monitoring Data Kualitas Udara</h3>
      <div class="card-actions" style="display:flex; gap:12px; align-items:center;">
        <select style="max-width: 220px;" onchange="window.location.href='/monitoring?deviceId='+this.value">
          <option value="tanjung-selor-device-1" <%=(typeof deviceId !=='undefined' &&
            deviceId==='tanjung-selor-device-1' ) ? 'selected' : '' %>>Tanjung Selor - Device 1</option>
          <option value="tanjung-selor-device-2" <%=(typeof deviceId !=='undefined' &&
            deviceId==='tanjung-selor-device-2' ) ? 'selected' : '' %>>Tanjung Selor - Device 2</option>
          <option value="tanjung-selor-device-3" <%=(typeof deviceId !=='undefined' &&
            deviceId==='tanjung-selor-device-3' ) ? 'selected' : '' %>>Tanjung Selor - Device 3</option>
        </select>
        <a href="/export/monitoring?deviceId=<%= typeof deviceId !== 'undefined' ? deviceId : 'tanjung-selor-device-1' %>"
          class="btn-secondary">ðŸ“¥ Export CSV</a>
      </div>
    </div>
    <div class="table-wrapper">
      <table class="table">
        <thead>
          <tr>
            <th>Waktu</th>
            <th>Lokasi</th>
            <th>PM2.5 (Î¼g/mÂ³)</th>
            <th>PM10 (Î¼g/mÂ³)</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <% if (!measurements || !measurements.length) { %>
            <tr>
              <td colspan="5" class="text-center">Belum ada data</td>
            </tr>
            <% } else { %>
              <% measurements.forEach(function(m) { %>
                <tr>
                  <td>
                    <%= new Date(m.timestamp).toLocaleString('id-ID') %>
                  </td>
                  <td>
                    <%= m.location || 'Tanjung Selor' %>
                  </td>
                  <td>
                    <%= m.pm25 %>
                  </td>
                  <td>
                    <%= m.pm10 %>
                  </td>
                  <td><span class="badge">
                      <%= m.status || 'UNKNOWN' %>
                    </span></td>
                </tr>
                <% }) %>
                  <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const ctx = document.getElementById('monitoringChart');
    if (!ctx) return;

    try {
      const rawData = JSON.parse(ctx.getAttribute('data-measurements'));
      // Sort ascending for chart (oldest to newest)
      const chartData = [...rawData].sort((a, b) => a.timestamp - b.timestamp);

      const labels = chartData.map(m => new Date(m.timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }));
      const pm25Data = chartData.map(m => m.pm25);
      const pm10Data = chartData.map(m => m.pm10);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'PM2.5',
              data: pm25Data,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              tension: 0.4,
              fill: true,
              borderWidth: 2,
              pointRadius: 2,
              pointHoverRadius: 6
            },
            {
              label: 'PM10',
              data: pm10Data,
              borderColor: '#3b82f6',
              backgroundColor: 'rgba(59, 130, 246, 0.1)',
              tension: 0.4,
              fill: true,
              borderWidth: 2,
              pointRadius: 2,
              pointHoverRadius: 6
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top',
              align: 'end',
              labels: {
                color: '#64748b',
                usePointStyle: true,
                padding: 20,
                font: { size: 13, weight: '600' }
              }
            },
            tooltip: {
              backgroundColor: '#ffffff',
              titleColor: '#1e293b',
              bodyColor: '#64748b',
              borderColor: '#e2e8f0',
              borderWidth: 1,
              padding: 12,
              displayColors: true,
              callbacks: {
                label: function (context) {
                  return context.dataset.label + ': ' + context.parsed.y + ' Î¼g/mÂ³';
                }
              }
            }
          },
          scales: {
            x: {
              grid: { color: '#f1f5f9', drawBorder: false },
              ticks: { color: '#64748b', font: { size: 11 }, maxTicksLimit: 12 }
            },
            y: {
              grid: { color: '#f1f5f9', drawBorder: false },
              ticks: { color: '#64748b', font: { size: 11 } },
              beginAtZero: true
            }
          },
          interaction: { intersect: false, mode: 'index' }
        }
      });
    } catch (e) {
      console.error("Error rendering chart:", e);
    }
  });
</script>